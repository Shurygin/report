<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8" />
    <title>Отчет по нарушениям</title>
    <script type="text/javascript" src="//code.jquery.com/jquery-latest.min.js"></script>
    <script type="text/javascript" src="//hst-api.wialon.com/wsdk/script/wialon.js"></script>
</head>
<body>
<style>
td, th{ border: 1px solid #c6c6c6; }
.wrap{ max-height:150px; overflow-y: auto; }
.odd, th{ background:#EEE; border: 1px solid #c6c6c6; }
ul{ list-style: none; margin:0px; padding:0px; display:block;overflow-y: auto; max-height: 200px;width: 300px}
label{ cursor:pointer; }	
</style>

<p>8</p>
<table>
	<tr>
		<td>Select resource and table:</td>
		<td>
			<select id="res"></select>
			<select id="templ">
				<option value="unit_trips">Trips</option>
				<option value="unit_stays">Stays</option>
				<option value="unit_group_ecodriving">Eco</option>
			</select>
		</td>
	</tr>
	<tr>
		<td>Select unit:</td>
		<td>
			<select id="units"></select>
		</td>
	</tr>
	<tr>
		<td>Select time interval:</td>
		<td>
			<select id="interval">
				<option value="86400" title="60 sec * 60 minutes * 24 hours = 86400 sec = 1 day">Last day</option>
				<option value="604800" title="86400 sec * 7 days = 604800 sec = 1 week">Last week</option>
				<option value="2592000" title="86400 sec * 30 days = 2592000 sec = 1 month">Last month</option>
			</select>
		</td>
	</tr>
	<tr>
		<td>Report Columns:</td>
		<td><ul id="columns"></ul></td>
	</tr>
	<tr><td colspan="2" style="text-align:center;"><input type="button" value="Execute report" id="exec_btn"/></td></tr>
</table>
<div id="log"></div>


<script type="text/javascript">
// Print message to log
function msg(text) {
	$("#log").prepend(text + "<br/>");
}
function init() { // Execute after login succeed
	// specify what kind of data should be returned
	var res_flags = wialon.item.Item.dataFlag.base | wialon.item.Resource.dataFlag.reports;
	var unit_flags = wialon.item.Item.dataFlag.base;
	var sess = wialon.core.Session.getInstance(); // get instance of current Session
	sess.loadLibrary("resourceReports"); // load Reports Library
	sess.updateDataFlags( // load items to current session
		[
			{ // 'avl_resource's specification
				type: "type",
				data: "avl_resource",
				flags: res_flags,
				mode: 0
			},
			{ // 'avl_unit's specification
				type: "type",
				data: "avl_unit_group",
				flags: unit_flags,
				mode: 0
			}
		],
		function(code) { // updateDataFlags callback
			if (code) {// exit if error code
				msg(wialon.core.Errors.getErrorText(code));
				return;
			}
			var res = sess.getItems("avl_resource"); // get loaded 'avl_resource's items
			if (!res || !res.length) { // check if resources found
				msg("Resources not found");
				return;
			}
			for (var i = 0; i < res.length; i++) // construct Select object using found resources
				$("#res").append("<option value='" + res[i].getId() + "'>" + res[i].getName() + "</option>");
			var units = sess.getItems("avl_unit_group"); // get loaded 'avl_units's items
			// check if units found
			if (!units || !units.length) {
				msg("Units not found");
				return;
			}
			for (var i = 0; i < units.length; i++) // construct Select object using found units
				$("#units").append("<option value='" + units[i].getId() + "'>" + units[i].getName() + "</option>");
		}
	);
		/*drawCheckboxes();
	$('#templ').change(drawCheckboxes);*/
}


function executeReport() { // execute selected report
	// get data from corresponding fields
	var id_res = $("#res").val(),
		templ = $("#templ").val(),
		id_unit = $("#units").val(),
		time = $("#interval").val();
	if (!id_res) {
		msg("Select resource");
		return;
	} // exit if no resource selected
	if (!id_unit) {
		msg("Select unit");
		return;
	} // exit if no unit selected
	var sess = wialon.core.Session.getInstance(); // get instance of current Session
	var res = sess.getItem(id_res); // get resource by id
	var to = sess.getServerTime(); // get current server time (end time of report time interval)
	var from = to - parseInt($("#interval").val(), 10); // calculate start time of report
	var columns = $("ul li .rep_col:checked"); // get columns, that need to be in a report
	// specify time interval object
	var interval = {
		"from": from,
		"to": to,
		"flags": wialon.item.MReport.intervalFlag.absolute
	};
	
	$("#exec_btn").prop("disabled", true); // disable button (to prevent multiclick while execute)
	var template = {// fill template object
		"id": 0,
		"n": "Отчет по нарушениям",
		"ct": "avl_unit_group",
		"p": "",
		"tbl": [{
				"n": "unit_group_ecodriving",
				"l": "Качество вождения",
				"c": "mileage,max_speed,violations_count,duration,violation_rank,violation_rating",
				"cl": "Пробег,Макс. скорость,Количество,Длительность,Оценка,Рейтинг по нарушениям",
				"s": "",
				"sl": "",
				"p": "",
				"sch": {
					"f1": 0,
					"f2": 0,
					"t1": 0,
					"t2": 0,
					"m": 0,
					"y": 0,
					"w": 0
				},
				"f": 0
			},
                        {
                            "c":"speed_limit",
                            "cl":"Установленное ограничение",
                            "f":4096,
                            "l":"Превышение скорости",
                            "n":"unit_group_speedings",
                            "p":"",
                            "s":"",
                            "sch":{"y":0,"m":0,"w":0,"f1":0,"f2":0,"t1":0,"t2":0},
                            "sl":""
                        }]
	};
	res.execReport(template, id_unit, 0, interval, // execute selected report
	function(code, data) { // execReport template
		$("#exec_btn").prop("disabled", false); // enable button
		if (code) {
			msg(wialon.core.Errors.getErrorText(code));
			return;
		} // exit if error code
		if (!data.getTables().length) { // exit if no tables obtained
			msg("<b>There is no data generated</b>");
			return;
		} else showReportResult(data); // show report result
	});
}
function showReportResult(result) { // show result after report execute
	var tables = result.getTables(); // get report tables
	var sess = wialon.core.Session.getInstance(); // get instance of current Session
	var to = sess.getServerTime();// get current server time (end time of report time interval)
	var toDate = new Date(to*1000);
	var from = to - parseInt($("#interval").val(), 10); // calculate start time of report
	var fromDate= new Date(from*1000);
	console.log("таблицы: "+tables);
	console.log("результат отчёта: "+result);
	if (!tables) return; // exit if no tables
	for (var i = 0; i < tables.length; i++) { // cycle on tables
		// html contains information about one table
		var html = "<table style='width:100%' cellspacing='0' cellpadding='0'><tr><td colspan='8'><b>ОТЧЕТ: КАЧЕСТВО РАБОТЫ ВОДИТЕЛЯ ТРАНСПОРТНОГО СРЕДСТВА</b><br>Период с "+fromDate.toLocaleString()+" по "+toDate.toLocaleString()+"<div class='wrap'></td></tr>";
		/*var headers = tables[i].header; // get table headers
		html += "<tr>"; // open header row
		for (var j = 0; j < headers.length; j++) // add header
			html += "<th>" + headers[j] + "</th>";
		html += "</tr>"; // close header row*/
		html +="<tr><td rowspan='2'>№</td><td rowspan='2'>Транспортное средство</td><td rowspan='2'>Пробег, км</td><td colspan='2'>Скорость, км/ч</td><td>Установленное ограниечение</td><td>Максимальная скорость</td><td rowspan='2'>кол-во превышений</td><td rowspan='2'>Общая продолжительность превышения скорости(чч:мм:сек)</td><td rowspan='2'>Оценка качества вождения</td></tr>";
		result.getTableRows(i, 0, tables[i].rows, // get Table rows				    
			function(code, rows) { // getTableRows callback
				console.log("rows= "rows);
				
				if (code) {
					msg(wialon.core.Errors.getErrorText(code));
					return;
				} // exit if error code
				for (var j in rows) { // cycle on table rows
					if (typeof rows[j].c == "undefined") continue; // skip empty rows
					html += "<tr" + (j % 2 == 1 ? " class='odd' " : "") + ">"; // open table row
					for (var k = 0; k < rows[j].c.length; k++) // add ceils to table
						html += "<td>" + getTableValue(rows[j].c[k]) + "</td>";
					//html += "</tr>"; // close table row
					console.log("ограничение для "+j+" элемента= "+rows[j].c[2]);
				}
				//html += "</table>";
				msg(html + "</div>");
			},
		this,html);
		
	}
}
function getTableValue(data) { // calculate ceil value
	if (typeof data == "object")
		if (typeof data.t == "string") return data.t;
		else return "";
		else return data;
}
// execute when DOM ready
$(document).ready(function() {
	$("#exec_btn").click(executeReport); // bind action to button click
	wialon.core.Session.getInstance().initSession("https://hst-api.wialon.com"); // init session
    // For more info about how to generate token check
    // http://sdk.wialon.com/playground/demo/app_auth_token
	wialon.core.Session.getInstance().loginToken("7436c5a313b456a0b6853835b59cf9f2A949F3F4C3AD984D17A07571F43D4CB2D8644C6B", "", // try to login
	function(code) { // login callback
		// if error code - print error message
		if (code) {
			msg(wialon.core.Errors.getErrorText(code));
			return;
		}
		msg("Logged successfully");
		init(); // when login suceed then run init() function
	});
});
</script>
</body>
</html>
